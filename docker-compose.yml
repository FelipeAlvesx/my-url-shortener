services:
    # Nginx Load Balancer
    nginx:
        image: nginx:alpine
        container_name: url-shortener-nginx
        ports:
            - "80:80"
        volumes:
            - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
        depends_on:
            - api-1
            - api-2
            - api-3
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://localhost/nginx-health",
                ]
            interval: 10s
            timeout: 5s
            retries: 3

    # API Instance 1
    api-1:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: url-shortener-api-1
        environment:
            - NODE_ENV=production
            - PORT=3000
            - DATABASE_URL=file:/app/data/dev.db
            - BASE_URL=http://localhost
            - JWT_SECRET=${JWT_SECRET}
        volumes:
            - db-data:/app/data
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://localhost:3000/health/ping",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # API Instance 2
    api-2:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: url-shortener-api-2
        environment:
            - NODE_ENV=production
            - PORT=3000
            - DATABASE_URL=file:/app/data/dev.db
            - BASE_URL=http://localhost
            - JWT_SECRET=${JWT_SECRET}
        volumes:
            - db-data:/app/data
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://localhost:3000/health/ping",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # API Instance 3
    api-3:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: url-shortener-api-3
        environment:
            - NODE_ENV=production
            - PORT=3000
            - DATABASE_URL=file:/app/data/dev.db
            - BASE_URL=http://localhost
            - JWT_SECRET=${JWT_SECRET}
        volumes:
            - db-data:/app/data
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://localhost:3000/health/ping",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

volumes:
    db-data:
        driver: local
